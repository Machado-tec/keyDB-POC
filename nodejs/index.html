<!DOCTYPE html>
<html>
<head>
  <title>KeyDB Log</title>
</head>
<body>
  <h1>Real-time Log of KeyDB Updates</h1>
  <div id="log1">keydb_01: No updates yet.</div>
  <div id="log2">keydb_02: No updates yet.</div>
  <div id="log3">keydb_03: No updates yet.</div>
  
  <!-- Buttons for each KeyDB instance -->
  <button id="interval-btn-01">Update Interval (keydb_01): Loading...</button>
  <button id="interval-btn-02">Update Interval (keydb_02): Loading...</button>
  <button id="interval-btn-03">Update Interval (keydb_03): Loading...</button>

  <!-- Explanation Section -->
  <h2>Funcionamento do Sistema</h2>
  <p>
    Este sistema demonstra um <strong>padrão observável</strong> utilizando KeyDB em um ambiente distribuído de replicação entre três instâncias KeyDB, com três botões interativos para controlar o intervalo de atualização de cada uma dessas instâncias.
  </p>
  <h3>Funcionamento:</h3>
  <ul>
    <li>A interface exibe três seções correspondentes a cada instância KeyDB (keydb_01, keydb_02, keydb_03). Cada seção mostra o valor da chave <code>shared_key</code> e o intervalo de atualização (<code>update_interval</code>).</li>
    <li>Cada botão diminui o intervalo de atualização de 10 para 1 segundo e, ao atingir 1 segundo, retorna para 10. O rótulo dos botões é atualizado automaticamente.</li>
  </ul>

  <h3>O que Comprova:</h3>
  <p>
    Este sistema comprova o funcionamento de um <strong>cluster KeyDB em modo de replicação ativa</strong>, onde cada instância de KeyDB está sincronizada, recebendo e replicando mudanças entre si. Ele também ilustra a utilização de um padrão observável para monitorar e controlar, em tempo real, o comportamento das instâncias KeyDB.
  </p>

  <script>
    const eventSource = new EventSource('/events');
    
    eventSource.onmessage = function(event) {
      const data = event.data;
      if (data.startsWith('keydb_01')) {
        document.getElementById('log1').innerHTML = data;
      } else if (data.startsWith('keydb_02')) {
        document.getElementById('log2').innerHTML = data;
      } else if (data.startsWith('keydb_03')) {
        document.getElementById('log3').innerHTML = data;
      }
    };

    // Fetch initial interval values for each KeyDB instance and update button labels
    const updateIntervalButtonLabel = (keydb, buttonId) => {
      fetch(`/get-interval/${keydb}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById(buttonId).textContent = `Update Interval (${keydb}): ${data.interval} seconds`;
        });
    };

    updateIntervalButtonLabel('keydb_01', 'interval-btn-01');
    updateIntervalButtonLabel('keydb_02', 'interval-btn-02');
    updateIntervalButtonLabel('keydb_03', 'interval-btn-03');

    // Handle button clicks to change the update interval for each KeyDB
    const intervalBtn01 = document.getElementById('interval-btn-01');
    intervalBtn01.onclick = function() {
      fetch('/change-interval/keydb_01', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          intervalBtn01.textContent = `Update Interval (keydb_01): ${data.newInterval} seconds`;
        });
    };

    const intervalBtn02 = document.getElementById('interval-btn-02');
    intervalBtn02.onclick = function() {
      fetch('/change-interval/keydb_02', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          intervalBtn02.textContent = `Update Interval (keydb_02): ${data.newInterval} seconds`;
        });
    };

    const intervalBtn03 = document.getElementById('interval-btn-03');
    intervalBtn03.onclick = function() {
      fetch('/change-interval/keydb_03', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          intervalBtn03.textContent = `Update Interval (keydb_03): ${data.newInterval} seconds`;
        });
    };
  </script>
</body>
</html>